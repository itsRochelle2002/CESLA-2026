<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - CLIMBS Membership</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Montserrat", sans-serif;
        background: var(--cesla-navy);
        background-image:
          radial-gradient(
            ellipse at 20% 50%,
            rgba(58, 72, 160, 0.6) 0%,
            transparent 60%
          ),
          radial-gradient(
            ellipse at 80% 50%,
            rgba(20, 28, 90, 0.8) 0%,
            transparent 60%
          );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* TOP BAR */
      .top-bar {
        background: linear-gradient(135deg, #1a3478 0%, #0d1b3e 100%);
        margin: 14px 18px 0;
        border-radius: 14px;
        padding: 13px 22px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
        gap: 12px;
      }
      .btn-back-topbar {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
      }
      .btn-back-topbar:hover {
        background: rgba(255, 255, 255, 0.22);
      }
      .top-bar-title {
        flex: 1;
        text-align: center;
        font-size: 1.05em;
        font-weight: 800;
        color: #fff;
        letter-spacing: 0.3px;
      }
      .top-bar-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .admin-chip {
        display: flex;
        align-items: center;
        gap: 7px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50px;
        padding: 6px 14px 6px 8px;
      }
      .admin-chip-icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
      }
      .admin-chip-name {
        font-size: 0.78em;
        font-weight: 700;
        color: #fff;
      }
      .btn-logout {
        background: #1a1a2e;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 9px 18px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.78em;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-logout:hover {
        background: #e74c3c;
      }

      /* LAYOUT */
      .main {
        display: flex;
        flex: 1;
        padding: 16px 18px 18px;
        gap: 16px;
      }
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 200px;
        flex-shrink: 0;
        padding-top: 10px;
      }
      .tab-btn {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.85);
        border: none;
        border-radius: 10px;
        padding: 12px 14px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.78em;
        font-weight: 700;
        cursor: pointer;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition:
          background 0.2s,
          transform 0.15s;
        width: 100%;
        letter-spacing: 0.3px;
      }
      .tab-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(2px);
      }
      .tab-btn.active {
        background: #f5c518;
        color: #1a1a2e;
      }
      .tab-btn .badge {
        background: #e74c3c;
        color: #fff;
        border-radius: 20px;
        padding: 2px 8px;
        font-size: 0.75em;
        font-weight: 800;
        margin-left: auto;
      }
      .tab-btn.active .badge {
        background: #1a1a2e;
      }
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-width: 0;
      }

      /* SEARCH & STATS */
      .search-bar {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .search-bar input {
        background: none;
        border: none;
        outline: none;
        font-family: "Montserrat", sans-serif;
        font-size: 0.88em;
        font-weight: 600;
        color: #fff;
        flex: 1;
      }
      .search-bar input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      .stats-row {
        display: flex;
        gap: 14px;
      }
      .stat-card {
        flex: 1;
        background: #1a3478;
        border-radius: 14px;
        padding: 20px 18px 18px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .stat-card .stat-label-top {
        font-size: 0.73em;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 12px;
        line-height: 1.4;
      }
      .stat-card .stat-num {
        font-size: 2.4em;
        font-weight: 800;
        color: #f5c518;
      }
      /* Legacy stat-label kept for compat */
      .stat-card .stat-label {
        font-size: 0.72em;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 2px;
      }

      /* Activity History */
      .activity-history-wrap {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .activity-title {
        font-size: 0.85em;
        font-weight: 800;
        color: #fff;
        letter-spacing: 0.3px;
      }

      /* Mini stats row for Account Management */
      .stats-row-mini {
        display: flex;
        gap: 10px;
      }
      .stat-card-mini {
        flex: 1;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 10px 12px;
        text-align: center;
      }
      .stat-num-mini {
        font-size: 1.4em;
        font-weight: 800;
        color: #f5c518;
      }
      .stat-label-mini {
        font-size: 0.68em;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 2px;
      }

      /* Inner tabs (for Account Management sub-panels) */
      .inner-tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .inner-tab {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.75);
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.74em;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s;
      }
      .inner-tab:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      .inner-tab.active {
        background: #f5c518;
        color: #1a1a2e;
      }
      .inner-panel {
        display: none;
        flex-direction: column;
        gap: 10px;
      }
      .inner-panel.active {
        display: flex;
      }

      /* PANELS */
      .panel {
        display: none;
        flex-direction: column;
        gap: 12px;
      }
      .panel.active {
        display: flex;
      }
      .panel-title {
        font-size: 0.9em;
        font-weight: 800;
        color: #f5c518;
        letter-spacing: 0.5px;
        padding-bottom: 4px;
        border-bottom: 2px solid rgba(245, 197, 24, 0.3);
      }

      /* WHITE CARD */
      .white-card {
        background: #fff;
        border-radius: 12px;
        padding: 22px 26px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      }
      .card-title {
        font-size: 0.9em;
        font-weight: 800;
        color: #2a3272;
        margin-bottom: 16px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      /* TABLE */
      .table-wrap {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78em;
      }
      thead tr {
        background: var(--cesla-navy);
        color: #fff;
      }
      thead th {
        padding: 11px 14px;
        text-align: left;
        font-weight: 700;
      }
      tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.15s;
      }
      tbody tr:hover {
        background: #fffbea;
      }
      tbody td {
        padding: 10px 14px;
        color: #1a1a2e;
        font-weight: 500;
        vertical-align: middle;
      }
      .empty-row td {
        text-align: center;
        color: #aaa;
        padding: 28px;
        font-weight: 600;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.82em;
        font-weight: 700;
      }
      .status-badge.pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-badge.approved {
        background: #d4edda;
        color: #155724;
      }
      .status-badge.rejected {
        background: #f8d7da;
        color: #721c24;
      }
      .action-btns {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .btn-approve,
      .btn-reject,
      .btn-view,
      .btn-txn {
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.75em;
        font-weight: 700;
        cursor: pointer;
        transition:
          opacity 0.2s,
          transform 0.15s;
      }
      .btn-approve {
        background: #28a745;
        color: #fff;
      }
      .btn-reject {
        background: #e74c3c;
        color: #fff;
      }
      .btn-view {
        background: var(--cesla-navy);
        color: #fff;
      }
      .btn-txn {
        background: #f5c518;
        color: #1a1a2e;
      }
      .btn-approve:hover,
      .btn-reject:hover,
      .btn-view:hover,
      .btn-txn:hover {
        opacity: 0.85;
        transform: translateY(-1px);
      }

      /* FORM INPUTS */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .form-grid.three {
        grid-template-columns: 1fr 1fr 1fr;
      }
      .form-grid.full {
        grid-template-columns: 1fr;
      }
      .form-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .form-item.span2 {
        grid-column: 1/-1;
      }
      .form-item label {
        font-size: 0.78em;
        font-weight: 700;
        color: #555;
      }
      .form-item input,
      .form-item select,
      .form-item textarea {
        padding: 10px 14px;
        border: 2px solid #e8e8f0;
        border-radius: 8px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.85em;
        font-weight: 600;
        color: #1a1a2e;
        outline: none;
        transition: border 0.2s;
        background: #fafafa;
      }
      .form-item input:focus,
      .form-item select:focus,
      .form-item textarea:focus {
        border-color: #2a3272;
        background: #fff;
      }
      .form-item textarea {
        resize: vertical;
        min-height: 70px;
      }
      .btn-form-submit {
        background: #28a745;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 28px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.88em;
        font-weight: 800;
        cursor: pointer;
        transition:
          background 0.2s,
          transform 0.2s;
        margin-top: 4px;
      }
      .btn-form-submit:hover {
        background: #218838;
        transform: translateY(-2px);
      }
      .btn-form-cancel {
        background: #eee;
        color: #333;
        border: none;
        border-radius: 10px;
        padding: 12px 28px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.88em;
        font-weight: 700;
        cursor: pointer;
        margin-top: 4px;
      }

      /* MEMBER SELECTOR */
      .member-search-wrap {
        position: relative;
      }
      .member-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 2px solid #2a3272;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      }
      .member-dropdown.show {
        display: block;
      }
      .member-option {
        padding: 10px 14px;
        font-size: 0.82em;
        font-weight: 600;
        cursor: pointer;
        color: #1a1a2e;
        border-bottom: 1px solid #f0f0f0;
      }
      .member-option:hover {
        background: #fffbea;
      }

      /* TRANSACTION TABLE */
      .txn-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78em;
      }
      .txn-table th {
        background: var(--cesla-navy);
        color: #fff;
        padding: 9px 12px;
        text-align: left;
        font-weight: 700;
      }
      .txn-table td {
        padding: 9px 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #1a1a2e;
        font-weight: 500;
      }
      .txn-table tr:hover td {
        background: #fffbea;
      }
      .amount-deposit {
        color: #28a745;
        font-weight: 800;
      }
      .amount-withdraw {
        color: #e74c3c;
        font-weight: 800;
      }

      /* MODAL */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 300;
        align-items: flex-start;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-box {
        background: #fff;
        border-radius: 16px;
        width: 100%;
        max-width: 800px;
        padding: 32px 36px;
        box-shadow: 0 24px 64px rgba(0, 0, 0, 0.4);
        animation: popIn 0.25s ease;
        margin: auto;
      }
      /* Detail rows in modals */
      .detail-row {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.82em;
      }
      .detail-row:last-child {
        border-bottom: none;
      }
      .detail-label {
        font-weight: 800;
        color: #2a3272;
        min-width: 140px;
        flex-shrink: 0;
        font-size: 0.92em;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .modal-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .modal-top h2 {
        font-size: 1em;
        font-weight: 800;
        color: #1a1a2e;
      }
      .btn-close-modal {
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.8em;
        font-weight: 700;
        cursor: pointer;
      }
      .app-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #1a1a2e;
        margin-bottom: 12px;
      }
      .app-header img {
        width: 75px;
        height: 75px;
        object-fit: contain;
        border-radius: 50%;
      }
      .app-header-info h3 {
        font-size: 1.1em;
        font-weight: 800;
        color: #1a1a2e;
      }
      .app-header-info p {
        font-size: 0.75em;
        color: #555;
        margin-top: 2px;
      }
      .photo-box-sm {
        width: 65px;
        height: 75px;
        border: 2px solid #1a1a2e;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65em;
        color: #777;
        text-align: center;
        font-weight: 600;
        margin-left: auto;
        flex-shrink: 0;
      }
      .app-form-title {
        text-align: center;
        font-size: 0.9em;
        font-weight: 800;
        text-decoration: underline;
        margin: 10px 0;
        color: #1a1a2e;
      }
      .field-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 20px;
        font-size: 0.78em;
      }
      .field-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .field-item label {
        font-weight: 700;
        color: #555;
        font-size: 0.85em;
      }
      .field-item span {
        font-weight: 600;
        color: #1a1a2e;
        border-bottom: 1px solid #ddd;
        padding-bottom: 2px;
        min-height: 20px;
      }
      .section-hdr {
        background: #e8e8e8;
        font-weight: 800;
        text-align: center;
        padding: 6px;
        font-size: 0.8em;
        letter-spacing: 1px;
        border-radius: 4px;
        margin: 14px 0 8px;
        color: #1a1a2e;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 2px solid #eee;
      }
      .modal-btn-approve {
        background: #28a745;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 32px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.9em;
        font-weight: 800;
        cursor: pointer;
      }
      .modal-btn-reject {
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 32px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.9em;
        font-weight: 800;
        cursor: pointer;
      }

      /* CONFIRM MODAL */
      .confirm-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 400;
        align-items: center;
        justify-content: center;
      }
      .confirm-overlay.active {
        display: flex;
      }
      .confirm-card {
        background: #fff;
        border-radius: 16px;
        padding: 32px 28px;
        max-width: 340px;
        width: 90%;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        animation: popIn 0.2s ease;
      }
      .confirm-icon {
        font-size: 2.8em;
      }
      .confirm-card h3 {
        font-size: 1em;
        font-weight: 800;
        color: #1a1a2e;
      }
      .confirm-card p {
        font-size: 0.8em;
        color: #555;
        line-height: 1.6;
      }
      .confirm-btns {
        display: flex;
        gap: 10px;
        width: 100%;
      }
      .confirm-btns button {
        flex: 1;
        padding: 11px;
        border: none;
        border-radius: 8px;
        font-family: "Montserrat", sans-serif;
        font-size: 0.82em;
        font-weight: 800;
        cursor: pointer;
      }
      .btn-yes-approve {
        background: #28a745;
        color: #fff;
      }
      .btn-yes-reject {
        background: #e74c3c;
        color: #fff;
      }
      .btn-cancel-confirm {
        background: #eee;
        color: #333;
      }

      /* TOAST */
      .toast {
        position: fixed;
        bottom: 28px;
        left: 50%;
        transform: translateX(-50%) translateY(80px);
        background: #1a1a2e;
        color: #fff;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 0.82em;
        font-weight: 700;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
        z-index: 500;
        white-space: nowrap;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
      }

      /* BALANCE SUMMARY CARDS */
      .balance-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 4px;
      }
      .balance-card {
        border-radius: 12px;
        padding: 16px 20px;
        color: #fff;
      }
      .balance-card.shares-bg {
        background: linear-gradient(135deg, #2a3272, #1a1a5e);
      }
      .balance-card.savings-bg {
        background: linear-gradient(135deg, #155724, #0d3d1a);
      }
      .balance-card.loans-bg {
        background: linear-gradient(135deg, #7a1c1c, #5a0d0d);
      }
      .balance-card label {
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 700;
        letter-spacing: 0.5px;
        display: block;
      }
      .balance-card .bal-amount {
        font-size: 1.4em;
        font-weight: 800;
        color: #f5c518;
        margin-top: 4px;
      }

      @media (max-width: 768px) {
        .main {
          flex-direction: column;
          padding: 14px;
        }
        .sidebar {
          width: 100%;
          flex-direction: row;
          flex-wrap: wrap;
        }
        .tab-btn {
          flex: 1;
          min-width: 100px;
          font-size: 0.72em;
        }
        .form-grid,
        .form-grid.three {
          grid-template-columns: 1fr;
        }
        .field-grid {
          grid-template-columns: 1fr;
        }
        .balance-cards {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <link rel="stylesheet" href="/css/global.css" />
  </head>
  <body>
    <!-- TOP BAR -->
    <div class="top-bar">
      <button class="btn-back-topbar" onclick="history.back()">&#8592;</button>
      <h1 class="top-bar-title">Admin's Dashboard</h1>
      <div class="top-bar-right">
        <div class="admin-chip">
          <span class="admin-chip-icon">&#128100;</span>
          <span class="admin-chip-name">Admin <%= adminName %></span>
        </div>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="main">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <button class="tab-btn active" onclick="switchTab('dashboard', this)">
          DASHBOARD
        </button>
        <button class="tab-btn" onclick="switchTab('pending', this)">
          Account Management
          <span class="badge" id="pendingBadge">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('members', this)">
          Members Monitoring
        </button>
        <button class="tab-btn" onclick="switchTab('loans', this)">
          Loan Management
        </button>
      </div>

      <!-- CONTENT -->
      <div class="content">
        <!-- ‚îÄ‚îÄ DASHBOARD PANEL (default) ‚îÄ‚îÄ -->
        <div class="panel active" id="panel-dashboard">
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-label-top">Total Pending Account</div>
              <div class="stat-num" id="statPending">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label-top">Total Approved Members</div>
              <div class="stat-num" id="statApproved">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label-top">Total Submitted Application Form</div>
              <div class="stat-num" id="statForms">0</div>
            </div>
          </div>
          <div class="activity-history-wrap">
            <div class="activity-title">Activity History</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width: 160px">DATE</th>
                    <th>ACTIVITY</th>
                  </tr>
                </thead>
                <tbody id="activityTableBody">
                  <tr class="empty-row">
                    <td colspan="2">No recent activity.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ ACCOUNT MANAGEMENT PANEL ‚îÄ‚îÄ -->
        <div class="panel" id="panel-pending">
          <div class="search-bar">
            <span>üîç</span>
            <input
              type="text"
              id="searchInput"
              placeholder="Search by name or username..."
              oninput="renderAll()"
            />
          </div>
          <div class="stats-row-mini">
            <div class="stat-card-mini">
              <div class="stat-num-mini" id="statTotal">0</div>
              <div class="stat-label-mini">Total</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-num-mini" id="statPendingAM">0</div>
              <div class="stat-label-mini">Pending</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-num-mini" id="statApprovedAM">0</div>
              <div class="stat-label-mini">Approved</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-num-mini" id="statRejected">0</div>
              <div class="stat-label-mini">Rejected</div>
            </div>
          </div>
          <div class="inner-tabs">
            <button
              class="inner-tab active"
              onclick="switchInnerTab('acc-pending', this)"
            >
              ‚è≥ Pending
            </button>
            <button
              class="inner-tab"
              onclick="switchInnerTab('acc-approved', this)"
            >
              ‚úÖ Approved
            </button>
            <button
              class="inner-tab"
              onclick="switchInnerTab('acc-rejected', this)"
            >
              ‚ùå Rejected
            </button>
            <button
              class="inner-tab"
              onclick="switchInnerTab('acc-forms', this)"
            >
              üìù App. Forms
              <span
                id="formsBadge"
                style="
                  background: #e74c3c;
                  color: #fff;
                  border-radius: 20px;
                  padding: 2px 7px;
                  font-size: 0.75em;
                  margin-left: 4px;
                "
                >0</span
              >
            </button>
          </div>

          <!-- inner sub-panels -->
          <div class="inner-panel active" id="inner-acc-pending">
            <div class="panel-title" style="font-size: 0.82em">
              ‚è≥ Pending Applications
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>User ID</th>
                    <th>Full Name</th>
                    <th>Date &amp; Time Applied</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="pendingTableBody">
                  <tr class="empty-row">
                    <td colspan="5">No pending applications.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="inner-panel" id="inner-acc-approved">
            <div class="panel-title" style="font-size: 0.82em">
              ‚úÖ Approved Accounts
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>User ID</th>
                    <th>Full Name</th>
                    <th>Date &amp; Time Approved</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="approvedTableBody">
                  <tr class="empty-row">
                    <td colspan="4">No approved members.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="inner-panel" id="inner-acc-rejected">
            <div class="panel-title" style="font-size: 0.82em">
              ‚ùå Rejected Accounts
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>User ID</th>
                    <th>Full Name</th>
                    <th>Date &amp; Time Rejected</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="rejectedTableBody">
                  <tr class="empty-row">
                    <td colspan="4">No rejected accounts.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="inner-panel" id="inner-acc-forms">
            <div class="panel-title" style="font-size: 0.82em">
              üìù Application Forms
            </div>
            <div class="search-bar" style="margin-bottom: 6px">
              <span>üîç</span>
              <input
                type="text"
                id="searchFormInput"
                placeholder="Search by name or User ID..."
                oninput="filterFormsTable()"
              />
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>User ID</th>
                    <th>Full Name</th>
                    <th>Date &amp; Time Submitted</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="formsTableBody">
                  <tr class="empty-row">
                    <td colspan="5">No application forms.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ MEMBERS MONITORING PANEL ‚îÄ‚îÄ -->
        <div class="panel" id="panel-members">
          <div class="panel-title">
            üë• Members Monitoring
            <span
              style="
                font-size: 0.75em;
                font-weight: 600;
                color: rgba(245, 197, 24, 0.7);
              "
            >
              ‚Äî Verified Co-op Members Only</span
            >
          </div>
          <div class="search-bar" style="margin-bottom: 4px">
            <span>üîç</span>
            <input
              type="text"
              id="searchInputMonitor"
              placeholder="Search by name or User ID..."
              oninput="filterVerifiedMembers()"
            />
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Full Name</th>
                  <th>User ID</th>
                  <th>Verified On</th>
                  <th>Shares</th>
                  <th>Savings</th>
                  <th>Active Loans</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="verifiedTableBody">
                <tr class="empty-row">
                  <td colspan="7">Loading verified members...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ SHARES / SAVINGS PANEL (now inside Loan Management) ‚îÄ‚îÄ -->
        <div class="panel" id="panel-shares" style="display: none">
          <div class="white-card">
            <div class="card-title">‚ûï Add Transaction</div>
            <div class="form-grid">
              <!-- Member Search -->
              <div class="form-item span2">
                <label>Select Member *</label>
                <div class="member-search-wrap">
                  <input
                    type="text"
                    id="txnMemberSearch"
                    placeholder="Type member name or username..."
                    autocomplete="off"
                    oninput="
                      searchMembers(
                        this.value,
                        'txnDropdown',
                        'txnMemberId',
                        'txnMemberName',
                      )
                    "
                  />
                  <div class="member-dropdown" id="txnDropdown"></div>
                  <input type="hidden" id="txnMemberId" />
                  <input type="hidden" id="txnMemberName" />
                </div>
              </div>
              <div class="form-item">
                <label>Transaction Type *</label>
                <select id="txnCategory">
                  <option value="">-- Select Type --</option>
                  <option value="shares-deposit">Shares ‚Äî Deposit</option>
                  <option value="shares-withdrawal">Shares ‚Äî Withdrawal</option>
                  <option value="savings-deposit">Savings ‚Äî Deposit</option>
                  <option value="savings-withdrawal">
                    Savings ‚Äî Withdrawal
                  </option>
                </select>
              </div>
              <div class="form-item">
                <label>Transaction Date *</label>
                <input type="date" id="txnDate" />
              </div>
              <div class="form-item">
                <label>Amount (‚Ç±) *</label>
                <input
                  type="number"
                  id="txnAmount"
                  placeholder="0.00"
                  min="0.01"
                  step="0.01"
                />
              </div>
              <div class="form-item">
                <label>OR Number</label>
                <input type="text" id="txnOR" placeholder="e.g. OR-0001" />
              </div>
              <div class="form-item span2">
                <label>Description</label>
                <input
                  type="text"
                  id="txnDesc"
                  placeholder="e.g. Monthly share contribution"
                />
              </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px">
              <button class="btn-form-submit" onclick="submitTransaction()">
                üíæ Save Transaction
              </button>
              <button class="btn-form-cancel" onclick="clearTxnForm()">
                ‚úï Clear
              </button>
            </div>
          </div>

          <!-- TRANSACTION HISTORY -->
          <div class="white-card">
            <div class="card-title">
              <span>üìã Transaction History</span>
              <div style="display: flex; gap: 8px; align-items: center">
                <select
                  id="txnHistoryFilter"
                  style="
                    padding: 6px 10px;
                    border: 2px solid #e8e8f0;
                    border-radius: 6px;
                    font-family: &quot;Montserrat&quot;, sans-serif;
                    font-size: 0.78em;
                    font-weight: 700;
                    outline: none;
                  "
                  onchange="loadTxnHistory()"
                >
                  <option value="all">All Members</option>
                </select>
                <select
                  id="txnTypeFilter"
                  style="
                    padding: 6px 10px;
                    border: 2px solid #e8e8f0;
                    border-radius: 6px;
                    font-family: &quot;Montserrat&quot;, sans-serif;
                    font-size: 0.78em;
                    font-weight: 700;
                    outline: none;
                  "
                  onchange="loadTxnHistory()"
                >
                  <option value="all">All Types</option>
                  <option value="shares">Shares Only</option>
                  <option value="savings">Savings Only</option>
                </select>
              </div>
            </div>
            <div class="balance-cards" id="balanceSummaryCards">
              <div class="balance-card shares-bg">
                <label>TOTAL SHARES</label>
                <div class="bal-amount" id="summaryShares">‚Ç± 0.00</div>
              </div>
              <div class="balance-card savings-bg">
                <label>TOTAL SAVINGS</label>
                <div class="bal-amount" id="summarySavings">‚Ç± 0.00</div>
              </div>
              <div class="balance-card loans-bg">
                <label>TOTAL LOANS</label>
                <div class="bal-amount" id="summaryLoans">‚Ç± 0.00</div>
              </div>
            </div>
            <div style="overflow-x: auto; margin-top: 12px">
              <table class="txn-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Member</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>OR No.</th>
                    <th>Amount</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody id="txnHistoryBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ LOANS PANEL ‚îÄ‚îÄ -->
        <div class="panel" id="panel-loans">
          <div class="panel-title">
            üè¶ Loan Management
            <span
              style="
                font-size: 0.75em;
                font-weight: 600;
                color: rgba(245, 197, 24, 0.7);
              "
            >
              ‚Äî Verified Co-op Members</span
            >
          </div>

          <!-- Loan Status Filter Tabs -->
          <div class="inner-tabs">
            <button
              class="inner-tab active"
              onclick="switchLoanTab('all', this)"
            >
              All Loans
            </button>
            <button class="inner-tab" onclick="switchLoanTab('pending', this)">
              ‚è≥ Pending
            </button>
            <button class="inner-tab" onclick="switchLoanTab('active', this)">
              ‚úÖ Approved
            </button>
            <button class="inner-tab" onclick="switchLoanTab('rejected', this)">
              ‚ùå Rejected
            </button>
            <button class="inner-tab" onclick="switchLoanTab('paid', this)">
              üí∞ Paid
            </button>
          </div>

          <!-- Loan Records Table -->
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Member Name</th>
                  <th>Loan No.</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Applied</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="loanApplicationsBody">
                <tr class="empty-row">
                  <td colspan="7">Loading loan records...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Add New Loan Application -->
          <div class="white-card" style="margin-top: 4px">
            <div class="card-title">‚ûï Add Loan Application</div>
            <div class="form-grid">
              <div class="form-item span2">
                <label>Select Verified Member *</label>
                <div class="member-search-wrap">
                  <input
                    type="text"
                    id="loanMemberSearch"
                    placeholder="Type member name or User ID..."
                    autocomplete="off"
                    oninput="
                      searchMembers(
                        this.value,
                        'loanDropdown',
                        'loanMemberId',
                        'loanMemberName',
                      )
                    "
                  />
                  <div class="member-dropdown" id="loanDropdown"></div>
                  <input type="hidden" id="loanMemberId" />
                  <input type="hidden" id="loanMemberName" />
                </div>
              </div>
              <div class="form-item">
                <label>Loan Type *</label>
                <select id="loanType">
                  <option value="">-- Select --</option>
                  <option value="regular">Regular Loan</option>
                  <option value="emergency">Emergency Loan</option>
                  <option value="educational">Educational Loan</option>
                  <option value="livelihood">Livelihood Loan</option>
                  <option value="others">Others</option>
                </select>
              </div>
              <div class="form-item">
                <label>Loan Amount (‚Ç±) *</label>
                <input
                  type="number"
                  id="loanAmount"
                  placeholder="0.00"
                  min="1"
                  step="0.01"
                  oninput="computeMonthly()"
                />
              </div>
              <div class="form-item">
                <label>Interest Rate (%)</label>
                <input
                  type="number"
                  id="loanInterest"
                  placeholder="e.g. 2"
                  min="0"
                  step="0.01"
                  oninput="computeMonthly()"
                />
              </div>
              <div class="form-item">
                <label>Term (Months) *</label>
                <input
                  type="number"
                  id="loanTerm"
                  placeholder="e.g. 12"
                  min="1"
                  oninput="computeMonthly()"
                />
              </div>
              <div class="form-item">
                <label>Date Released</label>
                <input type="date" id="loanDateReleased" />
              </div>
              <div class="form-item">
                <label>Monthly Payment (auto)</label>
                <input
                  type="text"
                  id="loanMonthly"
                  placeholder="‚Ç± 0.00"
                  readonly
                  style="background: #f0f0f8; color: #2a3272; font-weight: 800"
                />
              </div>
              <div class="form-item span2">
                <label>Purpose</label>
                <textarea
                  id="loanPurpose"
                  placeholder="Describe the purpose..."
                ></textarea>
              </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px">
              <button class="btn-form-submit" onclick="submitLoan()">
                üíæ Submit Loan Application
              </button>
              <button class="btn-form-cancel" onclick="clearLoanForm()">
                ‚úï Clear
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- end content -->
    </div>
    <!-- end main -->

    <!-- ‚îÄ‚îÄ LOAN TIMELINE MODAL ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="loanTimelineModal">
      <div class="modal-box" style="max-width: 600px">
        <div class="modal-top">
          <h2>üìã Loan Timeline</h2>
          <button
            class="btn-close-modal"
            onclick="closeModal('loanTimelineModal')"
          >
            ‚úï Close
          </button>
        </div>
        <div id="loanTimelineContent">Loading...</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ MEMBER DETAIL MODAL (for account management) ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="memberDetailModal">
      <div class="modal-box" style="max-width: 500px">
        <div class="modal-top">
          <h2 id="memberDetailTitle">üë§ Account Details</h2>
          <button
            class="btn-close-modal"
            onclick="closeModal('memberDetailModal')"
          >
            ‚úï Close
          </button>
        </div>
        <div id="memberDetailContent">Loading...</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VERIFIED MEMBER DETAIL MODAL ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="verifiedDetailModal">
      <div class="modal-box" style="max-width: 560px">
        <div class="modal-top">
          <h2 id="verifiedDetailTitle">üë§ Member Details</h2>
          <button
            class="btn-close-modal"
            onclick="closeModal('verifiedDetailModal')"
          >
            ‚úï Close
          </button>
        </div>
        <div id="verifiedDetailContent">Loading...</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ APPLICATION FORM MODAL ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="appModal">
      <div class="modal-box">
        <div class="modal-top">
          <h2>üìã Membership Application Form</h2>
          <button class="btn-close-modal" onclick="closeModal('appModal')">
            ‚úï Close
          </button>
        </div>
        <div id="modalFormContent"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ LOAN PAYMENT MODAL ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="paymentModal">
      <div class="modal-box" style="max-width: 500px">
        <div class="modal-top">
          <h2>üí≥ Record Loan Payment</h2>
          <button class="btn-close-modal" onclick="closeModal('paymentModal')">
            ‚úï Close
          </button>
        </div>
        <div
          id="paymentLoanInfo"
          style="
            background: #f0f4ff;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 16px;
            font-size: 0.82em;
            font-weight: 600;
            color: #2a3272;
          "
        ></div>
        <div class="form-grid">
          <input type="hidden" id="payLoanId" />
          <input type="hidden" id="payMemberId" />
          <div class="form-item">
            <label>Payment Date *</label>
            <input type="date" id="payDate" />
          </div>
          <div class="form-item">
            <label>Amount Paid (‚Ç±) *</label>
            <input
              type="number"
              id="payAmount"
              placeholder="0.00"
              min="0.01"
              step="0.01"
            />
          </div>
          <div class="form-item">
            <label>Principal Portion (‚Ç±)</label>
            <input
              type="number"
              id="payPrincipal"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
          </div>
          <div class="form-item">
            <label>Interest Portion (‚Ç±)</label>
            <input
              type="number"
              id="payInterest"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
          </div>
          <div class="form-item span2">
            <label>OR Number</label>
            <input type="text" id="payOR" placeholder="e.g. OR-0001" />
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 16px">
          <button class="btn-form-submit" onclick="submitPayment()">
            üíæ Save Payment
          </button>
          <button class="btn-form-cancel" onclick="closeModal('paymentModal')">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div class="confirm-overlay" id="confirmOverlay">
      <div class="confirm-card">
        <div class="confirm-icon" id="confirmIcon"></div>
        <h3 id="confirmTitle"></h3>
        <p id="confirmMsg"></p>
        <div class="confirm-btns">
          <button id="confirmYesBtn" onclick="executeAction()"></button>
          <button class="btn-cancel-confirm" onclick="closeConfirm()">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      let applications = [];
      let approvedMembers = [];
      let currentAction = null;
      let currentIndex = null;

      // ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ
      async function loadApplications() {
        try {
          const res = await fetch("/membership/admin/data");
          if (res.status === 401) {
            window.location.href = "/membership/admin";
            return;
          }
          applications = await res.json();
          approvedMembers = applications.filter((a) => a.status === "approved");
          populateMemberFilters();
        } catch (e) {
          applications = [];
        }
        renderAll();
      }

      function populateMemberFilters() {
        const opts =
          `<option value="all">All Members</option>` +
          approvedMembers
            .map(
              (m) =>
                `<option value="${m.id}">${m.full_name || m.username}</option>`,
            )
            .join("");
        const txnFilter = document.getElementById("txnHistoryFilter");
        if (txnFilter) txnFilter.innerHTML = opts;
        loadTxnHistory();
      }

      // ‚îÄ‚îÄ FORMS TABLE SEARCH FILTER ‚îÄ‚îÄ
      let allFormsData = [];
      function filterFormsTable() {
        const q = (
          document.getElementById("searchFormInput")?.value || ""
        ).toLowerCase();
        const filtered = allFormsData.filter(
          (a) =>
            (a.full_name || "").toLowerCase().includes(q) ||
            (a.user_id || "").toLowerCase().includes(q),
        );
        renderFormsTableFiltered(filtered);
      }
      function renderFormsTableFiltered(data) {
        const tbody = document.getElementById("formsTableBody");
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="5">No application forms found.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((a) => {
            const ri = applications.indexOf(a);
            const fs = a.form_status || "incomplete";
            const fsBadge = `<span class="status-badge ${fs === "submitted" ? "pending" : fs === "approved" ? "approved" : "rejected"}">${fs.toUpperCase()}</span>`;
            return `<tr>
            <td><strong>${a.user_id || "‚Äî"}</strong></td>
            <td>${(a.full_name || "").trim() || "‚Äî"}</td>
            <td style="white-space:nowrap;font-size:0.75em">${fmtDT(a.form_submitted_at)}</td>
            <td>${fsBadge}</td>
            <td><div class="action-btns">
              <button class="btn-view" onclick="viewFormModal(${ri})">üëÅÔ∏è View Form</button>
              <button class="btn-approve" onclick="approveForm(${a.id},'approve',${ri})">‚úÖ Approve</button>
              <button class="btn-reject" onclick="approveForm(${a.id},'reject',${ri})">‚ùå Return</button>
            </div></td>
          </tr>`;
          })
          .join("");
      }

      // ‚îÄ‚îÄ RENDER MEMBER TABLES ‚îÄ‚îÄ
      function renderAll() {
        const q = (
          document.getElementById("searchInput")?.value || ""
        ).toLowerCase();
        const filtered = applications.filter((a) => {
          const name = (a.full_name || "").toLowerCase();
          return (
            name.includes(q) ||
            (a.username || "").toLowerCase().includes(q) ||
            (a.user_id || "").toLowerCase().includes(q)
          );
        });
        const pending = filtered.filter((a) => a.status === "pending");
        const approved = filtered.filter((a) => a.status === "approved");
        const rejected = filtered.filter((a) => a.status === "rejected");

        // Submitted forms = approved accounts with submitted forms
        const formsSubmitted = applications.filter(
          (a) => a.status === "approved" && a.form_status === "submitted",
        );

        const nPending = applications.filter(
          (a) => a.status === "pending",
        ).length;
        const nApproved = applications.filter(
          (a) => a.status === "approved",
        ).length;
        const nRejected = applications.filter(
          (a) => a.status === "rejected",
        ).length;

        // Dashboard panel stats
        const elPending = document.getElementById("statPending");
        const elApproved = document.getElementById("statApproved");
        const elForms = document.getElementById("statForms");
        if (elPending) elPending.textContent = nPending;
        if (elApproved) elApproved.textContent = nApproved;
        if (elForms) elForms.textContent = formsSubmitted.length;

        // Account Management mini stats
        const elTotal = document.getElementById("statTotal");
        const elPendingAM = document.getElementById("statPendingAM");
        const elApprovedAM = document.getElementById("statApprovedAM");
        const elRejected = document.getElementById("statRejected");
        if (elTotal) elTotal.textContent = applications.length;
        if (elPendingAM) elPendingAM.textContent = nPending;
        if (elApprovedAM) elApprovedAM.textContent = nApproved;
        if (elRejected) elRejected.textContent = nRejected;

        // Badges
        const elPendingBadge = document.getElementById("pendingBadge");
        const elFormsBadge = document.getElementById("formsBadge");
        if (elPendingBadge) elPendingBadge.textContent = nPending;
        if (elFormsBadge) elFormsBadge.textContent = formsSubmitted.length;

        // Activity History ‚Äî show recent members (approved/rejected)
        renderActivityHistory();

        // Account Management sub-tables (use dedicated render functions)
        renderPendingTable(pending);
        renderApprovedTable(approved);
        renderRejectedTable(rejected);
        renderFormsTable(
          applications.filter(
            (a) => a.status === "approved" && a.form_status === "submitted",
          ),
        );
      }

      // renderFormsTable defined below

      async function approveForm(memberId, action, ri) {
        const label = action === "approve" ? "Approve" : "Return for Revision";
        if (!confirm(`${label} this application form?`)) return;
        try {
          const res = await fetch("/membership/admin/approve-form", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: memberId, action }),
          });
          const data = await res.json();
          if (data.success) {
            applications[ri].form_status =
              action === "approve" ? "approved" : "incomplete";
            renderAll();
            showToast(
              action === "approve"
                ? "‚úÖ Application form approved!"
                : "‚Ü©Ô∏è Form returned for revision.",
            );
          }
        } catch (e) {
          showToast("‚ùå Server error.");
        }
      }

      async function viewFormModal(ri) {
        const a = applications[ri];
        try {
          const res = await fetch(`/membership/admin/member-form/${a.id}`);
          const data = await res.json();
          renderFormModal(data);
        } catch (e) {
          renderFormModal(a);
        }
        document.getElementById("appModal").classList.add("active");
      }

      function fmtDT(dt) {
        if (!dt) return "‚Äî";
        const d = new Date(dt);
        return (
          d.toLocaleDateString("en-PH", {
            year: "numeric",
            month: "short",
            day: "numeric",
          }) +
          " " +
          d.toLocaleTimeString("en-PH", { hour: "2-digit", minute: "2-digit" })
        );
      }
      function fmtD(dt) {
        if (!dt) return "‚Äî";
        return new Date(dt).toLocaleDateString("en-PH", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }
      function fmtP(n) {
        return (
          "‚Ç±" +
          parseFloat(n || 0).toLocaleString("en-PH", {
            minimumFractionDigits: 2,
          })
        );
      }

      // Render pending accounts table
      function renderPendingTable(data) {
        const tbody = document.getElementById("pendingTableBody");
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="5">No pending applications.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((a) => {
            const ri = applications.indexOf(a);
            return `<tr>
            <td><strong>${a.user_id || "‚Äî"}</strong></td>
            <td>${(a.full_name || "").trim() || "‚Äî"}</td>
            <td style="white-space:nowrap;font-size:0.75em">${fmtDT(a.submitted_at)}</td>
            <td><span class="status-badge pending">PENDING</span></td>
            <td><div class="action-btns">
              <button class="btn-view" onclick="viewAccountDetail(${ri},'pending')">üëÅÔ∏è View Details</button>
              <button class="btn-approve" onclick="confirmAction('approve',${ri})">‚úÖ Approve</button>
              <button class="btn-reject" onclick="confirmAction('reject',${ri})">‚ùå Reject</button>
            </div></td>
          </tr>`;
          })
          .join("");
      }

      // Render approved accounts table
      function renderApprovedTable(data) {
        const tbody = document.getElementById("approvedTableBody");
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="4">No approved members.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((a) => {
            const ri = applications.indexOf(a);
            return `<tr>
            <td><strong>${a.user_id || "‚Äî"}</strong></td>
            <td>${(a.full_name || "").trim() || "‚Äî"}</td>
            <td style="white-space:nowrap;font-size:0.75em">${fmtDT(a.approved_at)}</td>
            <td><div class="action-btns">
              <button class="btn-view" onclick="viewAccountDetail(${ri},'approved')">üëÅÔ∏è View Details</button>
              <button class="btn-reject" onclick="confirmAction('reject',${ri})">‚ùå Reject</button>
            </div></td>
          </tr>`;
          })
          .join("");
      }

      // Render rejected accounts table
      function renderRejectedTable(data) {
        const tbody = document.getElementById("rejectedTableBody");
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="4">No rejected accounts.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((a) => {
            const ri = applications.indexOf(a);
            return `<tr>
            <td><strong>${a.user_id || "‚Äî"}</strong></td>
            <td>${(a.full_name || "").trim() || "‚Äî"}</td>
            <td style="white-space:nowrap;font-size:0.75em">${fmtDT(a.rejected_at)}</td>
            <td><div class="action-btns">
              <button class="btn-view" onclick="viewAccountDetail(${ri},'rejected')">üëÅÔ∏è View Details</button>
              <button class="btn-approve" onclick="confirmAction('approve',${ri})">‚úÖ Approve</button>
            </div></td>
          </tr>`;
          })
          .join("");
      }

      // Render app forms table (verified = approved form status)
      function renderFormsTable(data) {
        allFormsData = data; // save for search filter
        const tbody = document.getElementById("formsTableBody");
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="5">No application forms.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((a) => {
            const ri = applications.indexOf(a);
            const fs = a.form_status || "incomplete";
            const fsBadge = `<span class="status-badge ${fs === "submitted" ? "pending" : fs === "approved" ? "approved" : "rejected"}">${fs.toUpperCase()}</span>`;
            return `<tr>
            <td><strong>${a.user_id || "‚Äî"}</strong></td>
            <td>${(a.full_name || "").trim() || "‚Äî"}</td>
            <td style="white-space:nowrap;font-size:0.75em">${fmtDT(a.form_submitted_at)}</td>
            <td>${fsBadge}</td>
            <td><div class="action-btns">
              <button class="btn-view" onclick="viewFormModal(${ri})">üëÅÔ∏è View Form</button>
              <button class="btn-approve" onclick="approveForm(${a.id},'approve',${ri})">‚úÖ Approve</button>
              <button class="btn-reject" onclick="approveForm(${a.id},'reject',${ri})">‚ùå Return</button>
            </div></td>
          </tr>`;
          })
          .join("");
      }

      // Keep for compat (monitor table uses this)
      function renderMemberTable(tbodyId, data, actions) {
        // No longer used for account management; kept for monitor
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="6">No records found.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((a) => {
            const ri = applications.indexOf(a);
            const name = (a.full_name || "").trim() || "‚Äî";
            const date =
              a.approved_at || a.rejected_at || a.submitted_at || "‚Äî";
            const df = date !== "‚Äî" ? fmtDT(date) : "‚Äî";
            const btns = actions
              .map((act) => {
                if (act === "view")
                  return `<button class="btn-view" onclick="viewFormModal(${ri})">üëÅÔ∏è View Form</button>`;
                if (act === "txn")
                  return `<button class="btn-txn" onclick="quickTxn(${ri})">üí∞ Add Txn</button>`;
              })
              .join("");
            return `<tr><td>${a.application_no || "‚Äî"}</td><td>${name}</td><td><strong>${a.user_id || "‚Äî"}</strong></td><td style="font-size:0.75em">${df}</td><td><span class="status-badge ${a.status}">${a.status.toUpperCase()}</span></td><td><div class="action-btns">${btns}</div></td></tr>`;
          })
          .join("");
      }

      // ‚îÄ‚îÄ VIEW ACCOUNT DETAIL MODAL ‚îÄ‚îÄ
      async function viewAccountDetail(ri, type) {
        const a = applications[ri];
        const modal = document.getElementById("memberDetailModal");
        const content = document.getElementById("memberDetailContent");
        const title = document.getElementById("memberDetailTitle");
        content.innerHTML =
          '<div style="text-align:center;padding:30px;color:#888">Loading...</div>';
        modal.classList.add("active");

        if (type === "approved") {
          title.textContent = "‚úÖ Approved Account Details";
          try {
            const res = await fetch(`/membership/admin/member-creds/${a.id}`);
            const data = await res.json();
            if (!data.success) {
              content.innerHTML = "Failed to load.";
              return;
            }
            const m = data.member;
            content.innerHTML = `
              <div class="detail-row"><span class="detail-label">Full Name</span><span>${(a.full_name || "").trim() || "‚Äî"}</span></div>
              <div class="detail-row"><span class="detail-label">User ID</span><span style="font-weight:800;color:#2a3272">${m.user_id || "‚Äî"}</span></div>
              <div class="detail-row"><span class="detail-label">Password (Hashed)</span><span style="font-size:0.7em;word-break:break-all;color:#666">${m.password || "‚Äî"}</span></div>
              <div class="detail-row"><span class="detail-label">Applied At</span><span>${fmtDT(m.submitted_at)}</span></div>
              <div class="detail-row"><span class="detail-label">Approved At</span><span style="color:#155724;font-weight:700">${fmtDT(m.approved_at)}</span></div>`;
          } catch (e) {
            content.innerHTML = "Error loading details.";
          }
        } else if (type === "pending") {
          title.textContent = "‚è≥ Pending Account Details";
          content.innerHTML = `
            <div class="detail-row"><span class="detail-label">Full Name</span><span>${(a.full_name || "").trim() || "‚Äî"}</span></div>
            <div class="detail-row"><span class="detail-label">User ID</span><span style="font-weight:800;color:#2a3272">${a.user_id || "‚Äî"}</span></div>
            <div class="detail-row"><span class="detail-label">Applied At</span><span style="font-weight:700">${fmtDT(a.submitted_at)}</span></div>
            <div class="detail-row"><span class="detail-label">Status</span><span><span class="status-badge pending">PENDING</span></span></div>
            <div class="modal-actions" style="margin-top:16px">
              <button class="btn-approve" onclick="confirmAction('approve',${ri});closeModal('memberDetailModal')">‚úÖ Approve Account</button>
              <button class="btn-reject" onclick="confirmAction('reject',${ri});closeModal('memberDetailModal')">‚ùå Reject Account</button>
            </div>`;
        } else {
          title.textContent = "‚ùå Rejected Account Details";
          content.innerHTML = `
            <div class="detail-row"><span class="detail-label">Full Name</span><span>${(a.full_name || "").trim() || "‚Äî"}</span></div>
            <div class="detail-row"><span class="detail-label">User ID</span><span style="font-weight:800;color:#2a3272">${a.user_id || "‚Äî"}</span></div>
            <div class="detail-row"><span class="detail-label">Applied At</span><span>${fmtDT(a.submitted_at)}</span></div>
            <div class="detail-row"><span class="detail-label">Rejected At</span><span style="color:#721c24;font-weight:700">${fmtDT(a.rejected_at)}</span></div>`;
        }
      }

      // ‚îÄ‚îÄ VERIFIED MEMBERS ‚îÄ‚îÄ
      let verifiedMembers = [];
      async function loadVerifiedMembers() {
        try {
          const res = await fetch("/membership/admin/verified-members");
          verifiedMembers = await res.json();
        } catch (e) {
          verifiedMembers = [];
        }
        renderVerifiedTable(verifiedMembers);
      }

      function filterVerifiedMembers() {
        const q = (
          document.getElementById("searchInputMonitor")?.value || ""
        ).toLowerCase();
        const filtered = verifiedMembers.filter(
          (m) =>
            (m.full_name || "").toLowerCase().includes(q) ||
            (m.user_id || "").toLowerCase().includes(q),
        );
        renderVerifiedTable(filtered);
      }

      function renderVerifiedTable(data) {
        const tbody = document.getElementById("verifiedTableBody");
        if (!data.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="7">No verified members found.</td></tr>';
          return;
        }
        tbody.innerHTML = data
          .map((m, i) => {
            const hasShares = parseFloat(m.total_shares || 0) > 0;
            const hasSavings = parseFloat(m.total_savings || 0) > 0;
            const hasLoans = parseInt(m.loan_count || 0) > 0;
            return `<tr>
            <td><strong>${(m.full_name || "").trim() || "‚Äî"}</strong></td>
            <td style="font-weight:700;color:#2a3272">${m.user_id || "‚Äî"}</td>
            <td style="font-size:0.75em;white-space:nowrap">${fmtDT(m.form_approved_at)}</td>
            <td><span style="color:${hasShares ? "#155724" : "#999"};font-weight:700">${fmtP(m.total_shares)}</span></td>
            <td><span style="color:${hasSavings ? "#0c5460" : "#999"};font-weight:700">${fmtP(m.total_savings)}</span></td>
            <td><span style="color:${hasLoans ? "#721c24" : "#999"};font-weight:700">${fmtP(m.total_loan_balance)}${hasLoans ? " (" + m.loan_count + " loan" + (m.loan_count > 1 ? "s" : "") + ")" : ""}</span></td>
            <td><div class="action-btns">
              <button class="btn-view" onclick="viewVerifiedMember(${i})">üëÅÔ∏è View</button>
              <button class="btn-txn" onclick="quickTxnById(${m.id},'${(m.full_name || "").trim()}')">üí∞ Add Txn</button>
            </div></td>
          </tr>`;
          })
          .join("");
      }

      async function viewVerifiedMember(idx) {
        const m = verifiedMembers[idx];
        const modal = document.getElementById("verifiedDetailModal");
        const title = document.getElementById("verifiedDetailTitle");
        const content = document.getElementById("verifiedDetailContent");
        title.textContent = `üë§ ${(m.full_name || "").trim()}`;
        content.innerHTML =
          '<div style="text-align:center;padding:20px;color:#888">Loading...</div>';
        modal.classList.add("active");

        // Load shares, savings, loans for this member
        try {
          const [sharesRes, savingsRes, loansRes] = await Promise.all([
            fetch(`/membership/dashboard/shares`).catch(() => null),
            fetch(`/membership/dashboard/savings`).catch(() => null),
            fetch(`/membership/admin/member-loan-timeline/${m.id}`),
          ]);
          const timeline = await loansRes.json();

          content.innerHTML = `
            <div class="detail-row"><span class="detail-label">User ID</span><span style="font-weight:800">${m.user_id}</span></div>
            <div class="detail-row"><span class="detail-label">Verified On</span><span>${fmtDT(m.form_approved_at)}</span></div>
            <div class="detail-row"><span class="detail-label">Total Shares</span><span style="color:#155724;font-weight:700">${fmtP(m.total_shares)}</span></div>
            <div class="detail-row"><span class="detail-label">Total Savings</span><span style="color:#0c5460;font-weight:700">${fmtP(m.total_savings)}</span></div>
            <div class="detail-row"><span class="detail-label">Active Loan Balance</span><span style="color:#721c24;font-weight:700">${fmtP(m.total_loan_balance)}</span></div>
            ${
              timeline.loans && timeline.loans.length
                ? `
            <div style="margin-top:12px;font-weight:800;font-size:0.82em;color:#2a3272;padding-bottom:6px;border-bottom:2px solid #f0f0f0;margin-bottom:8px">LOAN RECORDS</div>
            ${timeline.loans
              .map(
                (l) => `
              <div style="background:#f8f9ff;border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:0.78em">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <strong>${l.loan_no}</strong>
                  <span class="status-badge ${l.status === "active" ? "approved" : l.status === "rejected" ? "rejected" : l.status === "paid" ? "approved" : "pending"}">${l.status.toUpperCase()}</span>
                </div>
                <div style="color:#666;margin-top:4px">${(l.loan_type || "").toUpperCase()} ‚Äî ${fmtP(l.amount)}</div>
                <div style="color:#999;margin-top:2px">Applied: ${fmtDT(l.applied_at || l.created_at)}</div>
                ${l.approved_at ? `<div style="color:#155724;margin-top:2px">Approved: ${fmtDT(l.approved_at)}</div>` : ""}
                ${l.rejected_at ? `<div style="color:#721c24;margin-top:2px">Rejected: ${fmtDT(l.rejected_at)}</div>` : ""}
              </div>`,
              )
              .join("")}`
                : '<div style="color:#999;font-size:0.82em;margin-top:10px">No loan records.</div>'
            }`;
        } catch (e) {
          content.innerHTML = `<div class="detail-row"><span class="detail-label">User ID</span><span style="font-weight:800">${m.user_id}</span></div><div style="color:#999;margin-top:10px;font-size:0.82em">Could not load full details.</div>`;
        }
      }

      function quickTxnById(memberId, memberName) {
        // Find in approved members and use existing quickTxn
        const idx = applications.findIndex((a) => a.id === memberId);
        if (idx !== -1) quickTxn(idx);
        else showToast("Member not found in applications list.");
      }

      // ‚îÄ‚îÄ LOAN APPLICATIONS ‚îÄ‚îÄ
      let allLoanApplications = [];
      let loanTabFilter = "all";

      async function loadLoanApplications() {
        try {
          const res = await fetch("/membership/admin/loan-applications");
          allLoanApplications = await res.json();
        } catch (e) {
          allLoanApplications = [];
        }
        renderLoanApplications();
      }

      function switchLoanTab(filter, btn) {
        loanTabFilter = filter;
        document
          .querySelectorAll("#panel-loans .inner-tab")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        renderLoanApplications();
      }

      function renderLoanApplications() {
        const tbody = document.getElementById("loanApplicationsBody");
        if (!tbody) return;
        let data = allLoanApplications;
        if (loanTabFilter !== "all")
          data = data.filter((l) => l.status === loanTabFilter);
        if (!data.length) {
          tbody.innerHTML = `<tr class="empty-row"><td colspan="7">No ${loanTabFilter === "all" ? "" : loanTabFilter} loans found.</td></tr>`;
          return;
        }
        tbody.innerHTML = data
          .map((l, i) => {
            const statusClass =
              l.status === "active"
                ? "approved"
                : l.status === "rejected"
                  ? "rejected"
                  : l.status === "paid"
                    ? "approved"
                    : "pending";
            const name = (l.full_name || "").trim() || "‚Äî";
            const appliedAt = l.applied_at || l.created_at;
            const actions = [];
            if (l.status === "pending") {
              actions.push(
                `<button class="btn-approve" onclick="approveLoan(${l.id},'active')">‚úÖ Approve</button>`,
              );
              actions.push(
                `<button class="btn-reject" onclick="approveLoan(${l.id},'rejected')">‚ùå Reject</button>`,
              );
            }
            actions.push(
              `<button class="btn-view" onclick="viewLoanTimeline(${l.member_id},'${name}')">üìã Timeline</button>`,
            );
            if (l.status === "active")
              actions.push(
                `<button class="btn-txn" onclick="openPaymentModal(${l.id},${l.member_id},'${l.loan_no}',${l.outstanding_balance})">üí≥ Payment</button>`,
              );
            return `<tr>
            <td style="cursor:pointer;font-weight:600" onclick="viewLoanTimeline(${l.member_id},'${name}')">${name}</td>
            <td style="font-size:0.75em">${l.loan_no}</td>
            <td>${(l.loan_type || "").toUpperCase()}</td>
            <td>${fmtP(l.amount)}</td>
            <td style="font-size:0.72em;white-space:nowrap">${fmtDT(appliedAt)}</td>
            <td><span class="status-badge ${statusClass}">${(l.status || "").toUpperCase()}</span></td>
            <td><div class="action-btns">${actions.join("")}</div></td>
          </tr>`;
          })
          .join("");
      }

      async function approveLoan(loanId, newStatus) {
        const label = newStatus === "active" ? "Approve" : "Reject";
        if (!confirm(`${label} this loan application?`)) return;
        try {
          const dateReleased =
            newStatus === "active"
              ? new Date().toISOString().split("T")[0]
              : null;
          const res = await fetch("/membership/admin/loan-status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              loan_id: loanId,
              status: newStatus,
              date_released: dateReleased,
            }),
          });
          const data = await res.json();
          if (data.success) {
            showToast(
              newStatus === "active"
                ? "‚úÖ Loan approved!"
                : "‚ùå Loan rejected.",
            );
            loadLoanApplications();
          }
        } catch (e) {
          showToast("‚ùå Server error.");
        }
      }

      async function viewLoanTimeline(memberId, memberName) {
        const modal = document.getElementById("loanTimelineModal");
        const content = document.getElementById("loanTimelineContent");
        document.querySelector("#loanTimelineModal h2").textContent =
          `üìã Loan Timeline ‚Äî ${memberName}`;
        content.innerHTML =
          '<div style="text-align:center;padding:30px;color:#888">Loading...</div>';
        modal.classList.add("active");
        try {
          const res = await fetch(
            `/membership/admin/member-loan-timeline/${memberId}`,
          );
          const data = await res.json();
          if (!data.success || !data.loans.length) {
            content.innerHTML =
              '<div style="text-align:center;color:#999;padding:30px">No loan records found.</div>';
            return;
          }
          content.innerHTML =
            data.loans
              .map((l) => {
                const events = [];
                const appliedAt = l.applied_at || l.created_at;
                events.push({
                  icon: "üìã",
                  label: "Loan Applied",
                  dt: appliedAt,
                  color: "#2a3272",
                  note: `${(l.loan_type || "").toUpperCase()} ‚Äî ${fmtP(l.amount)}`,
                });
                if (l.approved_at)
                  events.push({
                    icon: "‚úÖ",
                    label: "Loan Approved",
                    dt: l.approved_at,
                    color: "#155724",
                    note: `Released: ${fmtP(l.amount)}`,
                  });
                if (l.rejected_at)
                  events.push({
                    icon: "‚ùå",
                    label: "Loan Rejected",
                    dt: l.rejected_at,
                    color: "#721c24",
                    note: "",
                  });
                (l.payments || []).forEach((p) => {
                  events.push({
                    icon: "üí≥",
                    label: "Payment",
                    dt: p.payment_date,
                    color: "#0c5460",
                    note: `Paid: ${fmtP(p.amount_paid)} | Balance: ${fmtP(p.remaining_balance)}`,
                  });
                });
                events.sort((a, b) => new Date(a.dt) - new Date(b.dt));
                return `<div style="background:#f8f9ff;border-radius:12px;padding:14px 16px;margin-bottom:12px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <strong style="color:#2a3272">${l.loan_no} ‚Äî ${(l.loan_type || "").toUpperCase()}</strong>
                <span class="status-badge ${l.status === "active" ? "approved" : l.status === "rejected" ? "rejected" : l.status === "paid" ? "approved" : "pending"}">${l.status.toUpperCase()}</span>
              </div>
              <div style="position:relative;padding-left:20px">
                ${events
                  .map(
                    (ev, idx) => `
                  <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:${idx < events.length - 1 ? "12px" : "0"};position:relative">
                    ${idx < events.length - 1 ? '<div style="position:absolute;left:7px;top:22px;width:2px;height:calc(100% + 4px);background:#e0e0e0"></div>' : ""}
                    <div style="width:18px;height:18px;border-radius:50%;background:${ev.color};color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.6rem;flex-shrink:0;margin-top:2px">${ev.icon}</div>
                    <div>
                      <div style="font-weight:700;font-size:0.8em;color:${ev.color}">${ev.label}</div>
                      <div style="font-size:0.72em;color:#666;margin-top:1px">${fmtDT(ev.dt)}</div>
                      ${ev.note ? `<div style="font-size:0.72em;color:#888;margin-top:1px">${ev.note}</div>` : ""}
                    </div>
                  </div>`,
                  )
                  .join("")}
              </div>
            </div>`;
              })
              .join("") ||
            '<div style="color:#999;text-align:center;padding:20px">No loans found.</div>';
        } catch (e) {
          content.innerHTML = "Error loading timeline.";
        }
      }

      // ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ
      function switchTab(tab, btn) {
        document
          .querySelectorAll(".panel")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        const el = document.getElementById("panel-" + tab);
        if (el) el.classList.add("active");
        btn.classList.add("active");
        if (tab === "loans") loadLoanApplications();
        if (tab === "members") loadVerifiedMembers();
      }

      function switchInnerTab(tab, btn) {
        document
          .querySelectorAll(".inner-panel")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll(".inner-tab")
          .forEach((b) => b.classList.remove("active"));
        const el = document.getElementById("inner-" + tab);
        if (el) el.classList.add("active");
        btn.classList.add("active");
      }

      function renderActivityHistory() {
        const tbody = document.getElementById("activityTableBody");
        if (!tbody) return;
        // Build activity from applications: approvals, rejections, new registrations
        const events = [];
        for (const a of applications) {
          if (a.approved_at)
            events.push({
              date: a.approved_at,
              text: `‚úÖ ${a.full_name || a.user_id || "Member"} account approved`,
            });
          if (a.rejected_at)
            events.push({
              date: a.rejected_at,
              text: `‚ùå ${a.full_name || a.user_id || "Member"} account rejected`,
            });
          if (a.submitted_at && a.status === "pending")
            events.push({
              date: a.submitted_at,
              text: `üìã New registration: ${a.full_name || a.user_id || "Member"}`,
            });
          if (a.form_submitted_at)
            events.push({
              date: a.form_submitted_at,
              text: `üìù ${a.full_name || a.user_id || "Member"} submitted application form`,
            });
          if (a.form_approved_at)
            events.push({
              date: a.form_approved_at,
              text: `‚úÖ ${a.full_name || a.user_id || "Member"} application form approved`,
            });
        }
        events.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = events.slice(0, 30);
        if (!recent.length) {
          tbody.innerHTML =
            '<tr class="empty-row"><td colspan="2">No recent activity.</td></tr>';
          return;
        }
        tbody.innerHTML = recent
          .map((ev) => {
            const d = new Date(ev.date);
            const df =
              d.toLocaleDateString("en-PH", {
                year: "numeric",
                month: "short",
                day: "numeric",
              }) +
              " " +
              d.toLocaleTimeString("en-PH", {
                hour: "2-digit",
                minute: "2-digit",
              });
            return `<tr><td style="white-space:nowrap;font-size:0.75em;color:rgba(26,26,46,0.7)">${df}</td><td style="font-size:0.78em">${ev.text}</td></tr>`;
          })
          .join("");
      }

      // ‚îÄ‚îÄ VIEW APPLICATION FORM ‚îÄ‚îÄ
      async function viewApplication(index) {
        const a = applications[index];
        currentIndex = index;
        try {
          const res = await fetch(`/membership/admin/member/${a.id}`);
          const data = await res.json();
          renderAppForm(data, index);
        } catch (e) {
          renderAppForm(a, index);
        }
        document.getElementById("appModal").classList.add("active");
      }

      function renderFormModal(a) {
        const name =
          [a.first_name, a.middle_name, a.last_name]
            .filter(Boolean)
            .join(" ") || "‚Äî";
        const fam =
          (a.familyMembers || [])
            .map(
              (f) =>
                `<tr><td>${f.name || "‚Äî"}</td><td>${f.relation || "‚Äî"}</td><td>${f.age || "‚Äî"}</td><td>${f.occupation || "‚Äî"}</td></tr>`,
            )
            .join("") ||
          '<tr><td colspan="4" style="text-align:center;color:#aaa;padding:8px">No family members listed.</td></tr>';
        document.getElementById("modalFormContent").innerHTML = `
        <div class="app-header">
            <img src="/images/CESLA_logo.png" alt="CESLA" />
            <div class="app-header-info"><h3>CESLA Multi-Purpose Cooperative</h3><p>CLIMBS Bldg., National Highway, Bulua, CDO</p></div>
        </div>
        <div class="app-form-title" style="text-align:center;font-weight:900;text-decoration:underline;margin:10px 0;color:#1a1a2e">MEMBERSHIP APPLICATION FORM</div>
        <div class="field-grid">
            <div class="field-item"><label>User ID</label><span><strong>${a.user_id || "‚Äî"}</strong></span></div>
            <div class="field-item"><label>Form Status</label><span style="color:${a.form_status === "approved" ? "#28a745" : a.form_status === "submitted" ? "#2a3272" : "#856404"};font-weight:800">${(a.form_status || "incomplete").toUpperCase()}</span></div>
        </div>
        <div class="section-hdr">PERSONAL INFORMATION</div>
        <div class="field-grid">
            <div class="field-item"><label>Full Name</label><span>${name}</span></div>
            <div class="field-item"><label>Date of Birth</label><span>${a.birthdate || "‚Äî"}</span></div>
            <div class="field-item"><label>Place of Birth</label><span>${a.place_of_birth || "‚Äî"}</span></div>
            <div class="field-item"><label>Gender</label><span>${a.gender || "‚Äî"}</span></div>
            <div class="field-item"><label>Civil Status</label><span>${a.civil_status || "‚Äî"}</span></div>
            <div class="field-item"><label>Nationality</label><span>${a.nationality || "‚Äî"}</span></div>
            <div class="field-item"><label>Religion</label><span>${a.religion || "‚Äî"}</span></div>
            <div class="field-item"><label>SSS/GSIS No.</label><span>${a.sss_number || "‚Äî"}</span></div>
            <div class="field-item"><label>TIN No.</label><span>${a.tin_number || "‚Äî"}</span></div>
            <div class="field-item"><label>No. of Dependents</label><span>${a.dependents || "0"}</span></div>
        </div>
        <div class="section-hdr">ADDRESS</div>
        <div class="field-grid">
            <div class="field-item"><label>Present Address</label><span>${a.present_address || "‚Äî"}</span></div>
            <div class="field-item"><label>Permanent Address</label><span>${a.permanent_address || "‚Äî"}</span></div>
        </div>
        <div class="section-hdr">EMPLOYMENT</div>
        <div class="field-grid">
            <div class="field-item"><label>Employment Type</label><span>${a.employment_type || "‚Äî"}</span></div>
            <div class="field-item"><label>Position</label><span>${a.position || "‚Äî"}</span></div>
            <div class="field-item"><label>Employer/Business</label><span>${a.employer_name || "‚Äî"}</span></div>
            <div class="field-item"><label>Monthly Income</label><span>‚Ç±${parseFloat(a.monthly_income || 0).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</span></div>
        </div>
        <div class="section-hdr">FAMILY MEMBERS / BENEFICIARIES</div>
        <table style="width:100%;border-collapse:collapse;font-size:0.8em;margin-top:8px">
            <thead><tr style="background:var(--cesla-navy);color:#fff"><th style="padding:8px 10px;text-align:left">Name</th><th style="padding:8px 10px">Relation</th><th style="padding:8px 10px">Age</th><th style="padding:8px 10px">Occupation</th></tr></thead>
            <tbody>${fam}</tbody>
        </table>`;
        const ri = applications.findIndex((x) => x.id === a.id);
        let btns = "";
        if (a.form_status === "submitted")
          btns = `<button class="modal-btn-approve" onclick="closeModal('appModal');approveForm(${a.id},'approve',${ri})">‚úÖ Approve Form</button><button class="modal-btn-reject" onclick="closeModal('appModal');approveForm(${a.id},'reject',${ri})">‚Ü©Ô∏è Return for Revision</button>`;
        document.getElementById("modalActions").innerHTML = btns;
      }

      function renderAppForm(a, index) {
        const name =
          [a.first_name, a.middle_name, a.last_name]
            .filter(Boolean)
            .join(" ") || "‚Äî";
        document.getElementById("modalFormContent").innerHTML = `
        <div class="app-header">
            <img src="/images/CESLA_logo.png" alt="CESLA" />
            <div class="app-header-info"><h3>CESLA Multi-Purpose Cooperative</h3><p>CLIMBS Bldg., Upper Zone 5, National Highway, Bulua, Cagayan De Oro City</p><p>Email: cec@climbs.coop</p></div>
            <div class="photo-box-sm">2x2<br>Photo</div>
        </div>
        <div class="app-form-title">APPLICATION FORM</div>
        <div class="field-grid">
            <div class="field-item"><label>Application No.</label><span>${a.application_no || a.applicationNo || "‚Äî"}</span></div>
            <div class="field-item"><label>Date Submitted</label><span>${a.submitted_at || a.submittedAt ? new Date(a.submitted_at || a.submittedAt).toLocaleDateString() : "‚Äî"}</span></div>
        </div>
        <div class="section-hdr">PERSONAL DETAILS</div>
        <div class="field-grid">
            <div class="field-item"><label>Title</label><span>${a.title || "‚Äî"}</span></div>
            <div class="field-item"><label>Gender</label><span>${a.gender || "‚Äî"}</span></div>
            <div class="field-item"><label>Last Name</label><span>${a.last_name || a.lastName || "‚Äî"}</span></div>
            <div class="field-item"><label>First Name</label><span>${a.first_name || a.firstName || "‚Äî"}</span></div>
            <div class="field-item"><label>Middle Name</label><span>${a.middle_name || a.middleName || "‚Äî"}</span></div>
            <div class="field-item"><label>Date of Birth</label><span>${a.birthdate || "‚Äî"}</span></div>
            <div class="field-item"><label>Place of Birth</label><span>${a.place_of_birth || a.placeOfBirth || "‚Äî"}</span></div>
            <div class="field-item"><label>Civil Status</label><span>${a.civil_status || a.civilStatus || "‚Äî"}</span></div>
            <div class="field-item"><label>SSS/GSIS</label><span>${a.sss_number || a.sssNumber || "‚Äî"}</span></div>
            <div class="field-item"><label>TIN</label><span>${a.tin_number || a.tinNumber || "‚Äî"}</span></div>
        </div>
        <div class="section-hdr">CONTACT DETAILS</div>
        <div class="field-grid">
            <div class="field-item"><label>Present Address</label><span>${a.present_address || a.presentAddress || "‚Äî"}</span></div>
            <div class="field-item"><label>Permanent Address</label><span>${a.permanent_address || a.permanentAddress || "‚Äî"}</span></div>
        </div>
        <div class="section-hdr">ACCOUNT</div>
        <div class="field-grid">
            <div class="field-item"><label>Username</label><span><strong>${a.username || "‚Äî"}</strong></span></div>
            <div class="field-item"><label>Status</label><span style="color:${a.status === "approved" ? "#28a745" : a.status === "rejected" ? "#e74c3c" : "#856404"};font-weight:800">${(a.status || "").toUpperCase()}</span></div>
        </div>`;

        let btns = "";
        if (a.status === "pending")
          btns = `<button class="modal-btn-approve" onclick="closeModal('appModal');confirmAction('approve',${index})">‚úÖ Approve</button><button class="modal-btn-reject" onclick="closeModal('appModal');confirmAction('reject',${index})">‚ùå Reject</button>`;
        if (a.status === "rejected")
          btns = `<button class="modal-btn-approve" onclick="closeModal('appModal');confirmAction('approve',${index})">‚úÖ Approve</button>`;
        if (a.status === "approved")
          btns = `<button class="modal-btn-reject" onclick="closeModal('appModal');confirmAction('reject',${index})">‚ùå Revoke</button>`;
        document.getElementById("modalActions").innerHTML = btns;
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }

      // ‚îÄ‚îÄ QUICK TXN (from approved table) ‚îÄ‚îÄ
      function quickTxn(index) {
        const a = applications[index];
        switchTab("shares", document.querySelectorAll(".tab-btn")[3]);
        document.getElementById("txnMemberSearch").value =
          a.full_name || a.username;
        document.getElementById("txnMemberId").value = a.id;
        document.getElementById("txnMemberName").value =
          a.full_name || a.username;
        document.getElementById("txnDate").value = new Date()
          .toISOString()
          .split("T")[0];
        showToast("üë§ Member selected: " + (a.full_name || a.username));
      }

      // ‚îÄ‚îÄ MEMBER SEARCH DROPDOWN ‚îÄ‚îÄ
      function searchMembers(query, dropdownId, hiddenId, hiddenNameId) {
        const dropdown = document.getElementById(dropdownId);
        document.getElementById(hiddenId).value = "";
        if (!query.trim()) {
          dropdown.classList.remove("show");
          return;
        }
        const q = query.toLowerCase();
        // For loan management: use verifiedMembers (form_approved), fallback to approvedMembers
        const searchPool = verifiedMembers.length
          ? verifiedMembers
          : approvedMembers;
        const matches = searchPool.filter(
          (m) =>
            (m.full_name || "").toLowerCase().includes(q) ||
            (m.user_id || "").toLowerCase().includes(q) ||
            (m.username || "").toLowerCase().includes(q),
        );
        if (!matches.length) {
          dropdown.innerHTML =
            '<div class="member-option" style="color:#aaa">No verified members found</div>';
          dropdown.classList.add("show");
          return;
        }
        dropdown.innerHTML = matches
          .map(
            (m) =>
              `<div class="member-option" onclick="selectMember(${m.id},'${(m.full_name || m.username).replace(/'/g, "\\'")}','${dropdownId}','${hiddenId}','${hiddenNameId}')">${m.full_name || "‚Äî"} <span style="color:#888;font-size:0.85em">(${m.username})</span></div>`,
          )
          .join("");
        dropdown.classList.add("show");
      }

      function selectMember(id, name, dropdownId, hiddenId, hiddenNameId) {
        const inputId =
          dropdownId === "txnDropdown" ? "txnMemberSearch" : "loanMemberSearch";
        document.getElementById(inputId).value = name;
        document.getElementById(hiddenId).value = id;
        document.getElementById(hiddenNameId).value = name;
        document.getElementById(dropdownId).classList.remove("show");
      }

      // Close dropdowns on outside click
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".member-search-wrap")) {
          document
            .querySelectorAll(".member-dropdown")
            .forEach((d) => d.classList.remove("show"));
        }
      });

      // ‚îÄ‚îÄ SUBMIT TRANSACTION ‚îÄ‚îÄ
      async function submitTransaction() {
        const memberId = document.getElementById("txnMemberId").value;
        const category = document.getElementById("txnCategory").value;
        const date = document.getElementById("txnDate").value;
        const amount = document.getElementById("txnAmount").value;
        if (!memberId || !category || !date || !amount) {
          showToast("‚ùå Please fill all required fields.");
          return;
        }

        const [table, type] = category.split("-"); // shares/savings, deposit/withdrawal
        const endpoint = `/membership/admin/add-${table}`;

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              member_id: memberId,
              transaction_date: date,
              type,
              description: document.getElementById("txnDesc").value,
              amount,
              or_number: document.getElementById("txnOR").value,
            }),
          });
          const data = await res.json();
          if (data.success) {
            showToast(
              `‚úÖ ${table.charAt(0).toUpperCase() + table.slice(1)} ${type} saved! New balance: ‚Ç±${parseFloat(data.newBalance).toLocaleString("en-PH", { minimumFractionDigits: 2 })}`,
            );
            clearTxnForm();
            loadTxnHistory();
          } else {
            showToast("‚ùå " + (data.message || "Failed to save transaction."));
          }
        } catch (e) {
          showToast("‚ùå Server error.");
        }
      }

      function clearTxnForm() {
        ["txnMemberSearch", "txnDate", "txnAmount", "txnOR", "txnDesc"].forEach(
          (id) => (document.getElementById(id).value = ""),
        );
        document.getElementById("txnCategory").value = "";
        document.getElementById("txnMemberId").value = "";
      }

      // ‚îÄ‚îÄ LOAD TRANSACTION HISTORY ‚îÄ‚îÄ
      async function loadTxnHistory() {
        const memberFilter = document.getElementById("txnHistoryFilter").value;
        const typeFilter = document.getElementById("txnTypeFilter").value;

        try {
          const [sharesRes, savingsRes] = await Promise.all([
            fetch("/membership/admin/all-shares"),
            fetch("/membership/admin/all-savings"),
          ]);
          let shares = await sharesRes.json();
          let savings = await savingsRes.json();

          if (memberFilter !== "all") {
            shares = shares.filter((t) => String(t.member_id) === memberFilter);
            savings = savings.filter(
              (t) => String(t.member_id) === memberFilter,
            );
          }

          let combined = [];
          if (typeFilter !== "savings")
            combined = combined.concat(
              shares.map((t) => ({ ...t, table: "shares" })),
            );
          if (typeFilter !== "shares")
            combined = combined.concat(
              savings.map((t) => ({ ...t, table: "savings" })),
            );
          combined.sort(
            (a, b) =>
              new Date(b.transaction_date) - new Date(a.transaction_date),
          );

          // Summary
          const totalShares =
            shares
              .filter((t) => t.type === "deposit")
              .reduce((s, t) => s + parseFloat(t.amount), 0) -
            shares
              .filter((t) => t.type === "withdrawal")
              .reduce((s, t) => s + parseFloat(t.amount), 0);
          const totalSavings =
            savings
              .filter((t) => t.type === "deposit")
              .reduce((s, t) => s + parseFloat(t.amount), 0) -
            savings
              .filter((t) => t.type === "withdrawal")
              .reduce((s, t) => s + parseFloat(t.amount), 0);
          document.getElementById("summaryShares").textContent =
            "‚Ç± " +
            totalShares.toLocaleString("en-PH", { minimumFractionDigits: 2 });
          document.getElementById("summarySavings").textContent =
            "‚Ç± " +
            totalSavings.toLocaleString("en-PH", { minimumFractionDigits: 2 });

          const tbody = document.getElementById("txnHistoryBody");
          if (!combined.length) {
            tbody.innerHTML =
              '<tr><td colspan="7" style="text-align:center;color:#aaa;padding:20px;font-weight:600">No transactions found.</td></tr>';
            return;
          }
          tbody.innerHTML = combined
            .map((t) => {
              const member = approvedMembers.find((m) => m.id === t.member_id);
              const mName = member ? member.full_name || member.username : "‚Äî";
              const isDeposit = t.type === "deposit";
              return `<tr>
                <td>${new Date(t.transaction_date).toLocaleDateString("en-PH")}</td>
                <td>${mName}</td>
                <td><span class="status-badge ${isDeposit ? "approved" : "rejected"}" style="font-size:0.75em">${t.table.toUpperCase()} ${t.type.toUpperCase()}</span></td>
                <td>${t.description || "‚Äî"}</td>
                <td>${t.or_number || "‚Äî"}</td>
                <td class="${isDeposit ? "amount-deposit" : "amount-withdraw"}">${isDeposit ? "+" : "-"}‚Ç±${parseFloat(t.amount).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</td>
                <td style="font-weight:700">‚Ç±${parseFloat(t.balance).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</td>
            </tr>`;
            })
            .join("");
        } catch (e) {
          console.error(e);
        }
      }

      // ‚îÄ‚îÄ COMPUTE MONTHLY LOAN PAYMENT ‚îÄ‚îÄ
      function computeMonthly() {
        const amount =
          parseFloat(document.getElementById("loanAmount").value) || 0;
        const interest =
          parseFloat(document.getElementById("loanInterest").value) || 0;
        const term = parseInt(document.getElementById("loanTerm").value) || 0;
        if (amount && term) {
          const total = amount * (1 + interest / 100);
          const monthly = total / term;
          document.getElementById("loanMonthly").value =
            "‚Ç± " + monthly.toFixed(2);
        }
      }

      // ‚îÄ‚îÄ SUBMIT LOAN ‚îÄ‚îÄ
      async function submitLoan() {
        const memberId = document.getElementById("loanMemberId").value;
        const type = document.getElementById("loanType").value;
        const amount = document.getElementById("loanAmount").value;
        const interest = document.getElementById("loanInterest").value;
        const term = document.getElementById("loanTerm").value;
        const date = document.getElementById("loanDateReleased").value;
        if (!memberId || !type || !amount || !term || !date) {
          showToast("‚ùå Please fill all required fields.");
          return;
        }
        try {
          const res = await fetch("/membership/admin/add-loan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              member_id: memberId,
              loan_type: type,
              amount,
              interest_rate: interest || 0,
              term_months: term,
              date_released: date,
              purpose: document.getElementById("loanPurpose").value,
            }),
          });
          const data = await res.json();
          if (data.success) {
            showToast(`‚úÖ Loan released! Loan No: ${data.loanNo}`);
            clearLoanForm();
            loadLoanRecords();
          } else {
            showToast("‚ùå Failed to release loan.");
          }
        } catch (e) {
          showToast("‚ùå Server error.");
        }
      }

      function clearLoanForm() {
        [
          "loanMemberSearch",
          "loanAmount",
          "loanInterest",
          "loanTerm",
          "loanDateReleased",
          "loanPurpose",
          "loanMonthly",
        ].forEach((id) => (document.getElementById(id).value = ""));
        document.getElementById("loanType").value = "";
        document.getElementById("loanMemberId").value = "";
      }

      // ‚îÄ‚îÄ LOAD LOAN RECORDS ‚îÄ‚îÄ
      async function loadLoanRecords() {
        // Redirected to new loadLoanApplications
        await loadLoanApplications();
      }

      // ‚îÄ‚îÄ LOAN PAYMENT MODAL ‚îÄ‚îÄ
      function openPaymentModal(loanId, memberId, loanNo, balance, monthly) {
        document.getElementById("payLoanId").value = loanId;
        document.getElementById("payMemberId").value = memberId;
        document.getElementById("payDate").value = new Date()
          .toISOString()
          .split("T")[0];
        document.getElementById("payAmount").value = monthly || "";
        document.getElementById("payPrincipal").value = "";
        document.getElementById("payInterest").value = "";
        document.getElementById("payOR").value = "";
        document.getElementById("paymentLoanInfo").innerHTML =
          `<strong>Loan No:</strong> ${loanNo} &nbsp;|&nbsp; <strong>Outstanding Balance:</strong> <span style="color:#e74c3c;font-weight:800">‚Ç±${parseFloat(balance).toLocaleString("en-PH", { minimumFractionDigits: 2 })}</span>`;
        document.getElementById("paymentModal").classList.add("active");
      }

      async function submitPayment() {
        const loanId = document.getElementById("payLoanId").value;
        const memberId = document.getElementById("payMemberId").value;
        const date = document.getElementById("payDate").value;
        const amount = document.getElementById("payAmount").value;
        if (!date || !amount) {
          showToast("‚ùå Please fill required fields.");
          return;
        }
        try {
          const res = await fetch("/membership/admin/add-loan-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              loan_id: loanId,
              member_id: memberId,
              payment_date: date,
              amount_paid: amount,
              principal:
                document.getElementById("payPrincipal").value || amount,
              interest: document.getElementById("payInterest").value || 0,
              or_number: document.getElementById("payOR").value,
            }),
          });
          const data = await res.json();
          if (data.success) {
            showToast("‚úÖ Payment recorded successfully!");
            closeModal("paymentModal");
            loadLoanRecords();
          } else {
            showToast("‚ùå Failed to record payment.");
          }
        } catch (e) {
          showToast("‚ùå Server error.");
        }
      }

      // ‚îÄ‚îÄ CONFIRM APPROVE/REJECT ‚îÄ‚îÄ
      function confirmAction(action, index) {
        currentAction = action;
        currentIndex = index;
        const a = applications[index];
        const name = a.full_name || a.username;
        if (action === "approve") {
          document.getElementById("confirmIcon").textContent = "‚úÖ";
          document.getElementById("confirmTitle").textContent =
            "Approve Application?";
          document.getElementById("confirmMsg").textContent =
            `Approve membership of "${name}"?`;
          document.getElementById("confirmYesBtn").textContent = "Yes, Approve";
          document.getElementById("confirmYesBtn").className =
            "btn-yes-approve";
        } else {
          document.getElementById("confirmIcon").textContent = "‚ùå";
          document.getElementById("confirmTitle").textContent =
            "Reject Application?";
          document.getElementById("confirmMsg").textContent =
            `Reject application of "${name}"?`;
          document.getElementById("confirmYesBtn").textContent = "Yes, Reject";
          document.getElementById("confirmYesBtn").className = "btn-yes-reject";
        }
        document.getElementById("confirmOverlay").classList.add("active");
      }
      function closeConfirm() {
        document.getElementById("confirmOverlay").classList.remove("active");
      }

      async function executeAction() {
        closeConfirm();
        if (currentIndex === null || !currentAction) return;
        const a = applications[currentIndex];
        const newStatus = currentAction === "approve" ? "approved" : "rejected";
        try {
          const res = await fetch("/membership/admin/update-status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: a.id, status: newStatus }),
          });
          const data = await res.json();
          if (data.success) {
            applications[currentIndex].status = newStatus;
            showToast(`‚úÖ Member ${newStatus}!`);
            await loadApplications();
          }
        } catch (e) {
          showToast("‚ùå Error updating status.");
        }
        currentAction = null;
        currentIndex = null;
      }

      function logout() {
        fetch("/membership/admin/logout", { method: "POST" }).then(() =>
          window.location.replace("/membership/admin"),
        );
      }

      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3500);
      }

      // Close modals on backdrop click
      [
        "appModal",
        "paymentModal",
        "loanTimelineModal",
        "memberDetailModal",
        "verifiedDetailModal",
      ].forEach((id) => {
        const el = document.getElementById(id);
        if (el)
          el.addEventListener("click", function (e) {
            if (e.target === this) closeModal(id);
          });
      });

      // ‚îÄ‚îÄ REAL-TIME AUTO REFRESH ‚îÄ‚îÄ
      // Refresh applications every 30 seconds for real-time timestamps
      setInterval(() => {
        loadApplications();
      }, 30000);

      loadApplications();
    </script>
  </body>
</html>
